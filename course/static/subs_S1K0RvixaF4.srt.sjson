{"start":[20,4090,5735,7660,8860,10420,13240,17510,21445,24820,27250,29035,31180,33580,35200,36845,39180,41880,43645,47320,50120,51700,54360,56620,60515,64350,65850,67955,69955,71765,73625,77325,79555,82120,84175,87280,89605,91800,95755,99120,101400,102460,105600,110993,115275,118285,120930,123628,125010,126480,129499,133060,139480,142590,144015,145560,148110,152400,154305,158070,160390,162460,165780,169170,171780,173550,175700,179550,184190,188855,191445,193685,195920,199955,203270,205580,208400,210200,212480,214425,217730,218990,220250,224760,227660,229400,231230,234655,237650,239180,241345,244710,246940,248150,250145,254435,258515,260120,262735,266060,269370,271550,273835,276070,278485,281635,283780,287110,288550,290910,293770,296800,298540,302500,304470,306550,308725,312370,317095,319510,322945,324880,327835,333490,335140,338470,340850,343755,346700,347880,349460,350600,352490,355965,358760,360890,362180,364035,365570,367700,369455,372920,375140,376910,379160,382585,383870,388110,390080,393335,394970,397730,399435,400828,403640,406880,409055,413405,416875,419945,421965,423860,426610,428740,431380,434365,438425,440485,442910,444710,446170,448965,451510,453869,456050,458785,462730,465325,467205,469470,470800,472540,474505,476860,478930,480775,484390,485710,486580,488750,491147,494070,497060,499620,502410,503040,505560,507630,510560,513190,516775,518500,520595,522040,523480,526060,528295,530350,533665,538320,543070,544930,547900,550660,553980,555970,558910,561825,563170,564425,565600,567400,570205,575010,576170,579530,581960,583520,585035,587660,590600,592550,593840,597890,600755,603870,605785,607970,609719,611615,613925,616750,618425,619730,621560,625430,627350,629995,632790,635586,638385,642445,644690,650735,653930,658250,661280,665805,668000,670325,673130,676280,678700,679670,681145,683015,685145,687440,690020,692030,693320,694855,696320,698720,700335,701660,703490,706940,708680,710240,711540,712960,714997,716795,718730,721640,723620,727680,731720,734740,740090,741801,744495,746300,748925,753440,755805,759005,762585,766835,768640,771945,773490,777960,781500,784980,786070,788580,790260,792030,793993,795360,797150,798510,802650,804373,807290,810970,813450,815600,817065,819425,821570,824810,829550,833425,835700,839625,841070,843665,845810,846830,847970,852340,855290,859385,861200,863060,865370,867940,869895,874095,877960,882240,884220,886880,892425,896430,898290,899640,902330,903915,906770,908685,912060,914400,915990,917830,923260,927690,929310,931950,934140,936385,941220,943940,946670,950270,953912,956851,961900,966067,968230,971665,974585,975890,978380,980990,985350,987920,991855,995880],"end":[4090,5735,7660,8860,10420,13240,17510,21445,24820,27250,29035,31180,33580,35200,36845,39180,41880,43645,47320,50120,51700,54360,56620,60515,64350,65850,67955,69955,71765,73625,77325,79555,82120,84175,87280,89605,91800,95755,99120,101400,102460,105600,110993,115275,118285,120930,123628,125010,126480,129499,133060,139480,142590,144015,145560,148110,152400,154305,158070,160390,162460,165780,169170,171780,173550,175700,179550,184190,188855,191445,193685,195920,199955,203270,205580,208400,210200,212480,214425,217730,218990,220250,224760,227660,229400,231230,234655,237650,239180,241345,244710,246940,248150,250145,254435,258515,260120,262735,266060,269370,271550,273835,276070,278485,281635,283780,287110,288550,290910,293770,296800,298540,302500,304470,306550,308725,312370,317095,319510,322945,324880,327835,333490,335140,338470,340850,343755,346700,347880,349460,350600,352490,355965,358760,360890,362180,364035,365570,367700,369455,372920,375140,376910,379160,382585,383870,388110,390080,393335,394970,397730,399435,400828,403640,406880,409055,413405,416875,419945,421965,423860,426610,428740,431380,434365,438425,440485,442910,444710,446170,448965,451510,453869,456050,458785,462730,465325,467205,469470,470800,472540,474505,476860,478930,480775,484390,485710,486580,488750,491147,494070,497060,499620,502410,503040,505560,507630,510560,513190,516775,518500,520595,522040,523480,526060,528295,530350,533665,538320,543070,544930,547900,550660,553980,555970,558910,561825,563170,564425,565600,567400,570205,575010,576170,579530,581960,583520,585035,587660,590600,592550,593840,597890,600755,603870,605785,607970,609719,611615,613925,616750,618425,619730,621560,625430,627350,629995,632790,635586,638385,642445,644690,650735,653930,658250,661280,665805,668000,670325,673130,676280,678700,679670,681145,683015,685145,687440,690020,692030,693320,694855,696320,698720,700335,701660,703490,706940,708680,710240,711540,712960,714997,716795,718730,721640,723620,727680,731720,734740,740090,741801,744495,746300,748925,753440,755805,759005,762585,766835,768640,771945,773490,777960,781500,784980,786070,788580,790260,792030,793993,795360,797150,798510,802650,804373,807290,810970,813450,815600,817065,819425,821570,824810,829550,833425,835700,839625,841070,843665,845810,846830,847970,852340,855290,859385,861200,863060,865370,867940,869895,874095,877960,882240,884220,886880,892425,896430,898290,899640,902330,903915,906770,908685,912060,914400,915990,917830,923260,927690,929310,931950,934140,936385,941220,943940,946670,950270,953912,956851,961900,966067,968230,971665,974585,975890,978380,980990,985350,987920,991855,995880,998000],"text":["In this video, we're going to go over consistency,","what are the trade-offs that you all want","to think about for your application,","and how you going to configure","your Cosmos DB so that you have","the optimal trade-offs between consistency,","availability, and performance for your application.","To help set the context","and take a look at the trade-offs for consistency,","let's take a look at an example.","So let's say we have a Cosmos DB account","that's configured in West U. S., East, U.S.,","and North Europe, and what we're looking here is","an individual partition set","within that Cosmos DB account.","So we have a set of resource partitions in","which we have a set of replicas within regions.","And what we're going to do is we're going to be","replicating that data across these different regions.","Now, behind the scenes,","Cosmos DB actually maintains a set of","four replicas in each individual region.","And this is how it's able to guarantee","a high availability with","SLA's of four nines even with a single region,","and that's because there's","a high amount of redundancy even within the region.","Basically, we have a set of four replicas,","one is designated as a leader,","the others are designated as followers,","one of them are forwarder that replicates across regions.","And any time a write comes in,","what will happen is replication","within the region is going to be synchronous.","The write will be replicated to a quorum of","replicas within that region","before acknowledging that write.","Now, doing replication across geographic regions,","these regions are going to be much further away.","And as a result, when","you're dealing with these high latencies,","large geographic distances, what you want to","do is replication asynchronously.","While consistency is something that is often desired,","there's going to be very meaningful trade-offs here.","So, let's take a look at what these trade-offs are.","And to illustrative an example,","what we're going to do is","we're going to put a record in each","of these different regions whose value is five.","And we're going to update that value from five to six.","Now, what we've done is we've replicated five to six,","the new record in this local region.","We acknowledge the update.","And now we're going to start","propagating that value from five to six over to","these more distant geographic other regions,","these other resource partitions.","And the first example that you want to think about is,","what happens if a network partition is introduced?","Like what happens if,","let's say there a major storm like","a natural disaster or a hurricane that has come","in between these two regions","and is disrupting the network","between the two regions so","that propagating the data becomes problematic?","So, if we have an observer that's constantly reading","values out of the secondary region,","what should be the behavior of that reader?","Should it see the old value which is five?","Meaning, it's going to prioritize availability.","Or in the event of this network partition,","it's going to be a while before this region is caught up.","So, does availability get","sacrificed and the system goes off line so that we can","prioritize consistency and make sure","that we never serve","the value five when it should have been updated to six?","Meaning, we want to prioritize consistency.","Most people understand this","or know this as Brewer's CAP theorem.","And CAP theorem, what it states is it's impossible for","a distributed data store to simultaneously provide","more than two out of three following","guarantees: consistency,","availability, and partition tolerance.","Now, CAP theorem only talks about","the exceptional case which is","what happens when failures occur.","And given that distributed data store","needs to have protection tolerance,","are you going to have a system","that prioritizes its consistency","or a system that prioritizes availability?","But the trade-offs actually go much deeper than that.","And that's because even in","the happy case where there's no failure,","the latency between two distant geographic regions is","going to be high because a packet,","the speed at which information can travel,","is going to be bounded by the speed of light.","So, if you shine a beam of light from","North America to the other side of the world,","we're talking about one-way distance","of about like 80 milliseconds","so the round trip time is going to add up to","hundreds of milliseconds and that's","under ideal network conditions.","So, now if we do this update from five to six,","and we have a set of readers looking at,","\"Hey, what is the value here?\"","And it perhaps has propagated to this region quicker","because the network conditions","are ideal and for this one,","this region it might be a little bit further out.","So, what is the value when this reader reads?","And should reader B see the value five immediately?","Meaning, it's going to set a stale read","because latency is really what it prioritizes.","And you might think of a scenario like","a social media application where it's okay if","you see your friends' wall posts a little bit later.","What you want is very,","very quick page load times.","Or is it going to sit around","and make sure that it doesn't serve any stale reads.","Since the update, five to six has","already started propagating into","additional other regions,","it's going to sit around and make","sure it's fully caught up.","It's going to establish quorum with the other regions.","Meaning, in order to get the quorum,","you're actually going to want to read from a set of","replicas which is going to","negatively impact your throughput.","And then you're also going to wait","for those replicas to catch up.","Meaning, you're also going to sacrifice","latency just so that you can prioritize consistency.","So there's actually a very real trade-off","between consistency and","the performance of the application in terms","of latency and throughput.","This has been codified in","the academic world as PACELC theorem,","which states in the case of","a network partition in a distributed computer system,","one has to choose between","availability A and consistency","C. So this is basically CAP theorem.","This is the PAC and PACELC.","Else, when the system is","running normally in the absence of any network partition,","meaning around the steady normal state,","one still has to choose between latency and consistency.","Now, the difficult thing for","most commercial database systems","is they force you into extremes.","They make you choose between","an eventual consistency which","offers low latency characteristics,","and strong consistency which","has high latency characteristics.","And the world is very black and white.","But the thing is that,","for applications, making the shut","off is not always so easy.","You want low latency but at","the same time you want consistency.","And so, what Cosmos DB allows","you to do is adds a few enumerate array,","quick stops in which","there's five well-defined consistency models,","and you can configure this at the account level and","then override the consistency option","on a per request basis.","And what these consistency models","are intended to do is give you","clear trade-offs with regards to","latency, availability, and throughput,","so that you're not having to deal with","confusing quorum configurations,","replication configurations,","data set configurations which","often and each of","these different layers you're","going to introduce mistakes.","The way you configure this in Cosmos DB","is you go to the Azure portal and under settings,","you're going to see a menu entry","called default consistency and you can set","a default consistency for that database account and","choose from one of","these five well-defined consistency models,","that is, strong, bounded staleness, session,","consistent prefix, and eventual.","And basically, if you","know where to plot this on along a graph,","going from left to right,","from strong to eventual,","basically as you go to right,","you're going to get lower latency,","higher availability, and better read scalability.","Meaning, better throughput characteristics","as you go from left to right.","And if you go from right to left,","you're going to get basically stronger consistency.","Aspects. Now, let's take a look at","what each of","these different consistency models really mean.","For strong consistency, this is basically","a concept of perfect consistency.","And in the academic world,","what we call this is Linearizability,","or what we're guaranteeing is linearizability.","And what that means is that once","an operation is complete,","so let's say I perform","a write operation and I acknowledge it,","it is guaranteed that it will be visible to","all subsequent requests in that database system.","Now, as we relax","consistency so that we can get lower latency,","a higher availability, and better read scalability,","what are these additional consistency","levels that we can define?","For bounded staleness, what it's going to","offer is the concept of a consistent prefix,","and what a consistent prefix","means is that replication will","always happen in order.","So, you never see out-of-order records,","out-of-order writes when you perform a reader press.","And to give you an example, if we were","to write operation one,","perform write operation two,","and perform write operation three,","you're not going to see operations one and","three with a gap in time missing two.","You're also not going to see three,","two, and then one, you're not going","to see out-of-order writes.","The prefix is always going to be consistent.","So if you see two, you're guaranteed to see one.","If you see three, you're guaranteed to see two and one,","and those are going to be in order.","Furthermore, for bounded staleness,","what it's basically guaranteeing is you'll get","perfect consistency outside of a staleness window.","But within that staleness window,","you're going to see only consistent prefix guarantees and","this staleness window is basically defined","by two numeric values.","One is a time interval and the other","is a number of k operations happening.","And this is actually a really nice tradeoff for if","you have an application that requires","high availability and you want","reasonable latency while typically","you still want something that's strong and consistent,","do understand this is actually a","very, very good trade-off.","Now, for session consistency,","rather than having a staleness window","and guaranteeing strong consistency outside of","the staleness window and then","guaranteeing a consistent prefix","within this staleness window,","for session consistency,","what you're doing is you're basically","guaranteeing strong consistency within","the scope of a session.","And this way, you don't have to pay","the performance penalty of","getting a globally strong consistency but rather,","within that scope of a session,","you're going to get monotonic rates,","you're going to get monotonic rates,","you're going to be able to read your own writes","and writes will always follow the reads.","And if you read a value,","you can expect all subsequent","reads to also have that value,","and if you perform write","requests when you find it after that request,","all subsequent operations will","also respect that write request.","Now, this is the most popular consistency model","in terms of usage in CosmosDB,","and that's because they offer us","a very nice blend of","predictable consistency for the session,","as well as a very good throughput","and latency characteristics.","The other consistency models are consistent prefix,","meaning the only consistency guarantee is that","you'll never see these out-of-order writes,","or you won't see any gaps in time,","or eventual consistency.","And eventually, it's going to be the weakest form","of consistency in which the only guarantee","is the replicas will eventually converge.","And the reason for choosing this is it has","the lowest cost for","reads out of all of the consistency levels,","meaning a read can","always be served out of a single replica,","it doesn't need to achieve quorum,","and it's always going to have the","lowest latency possible, too,","because you can read from","the nearest replica and immediately return.","Now, for boundless staleness,","I mentioned that you can configure a maximum lag in","terms of operations and maximum lag in terms of time.","This is really not as complicated as it sounds.","It's basically two numeric","fields that you're going to fill out.","What is the max lag in terms of time?","What is the max lag in term of the operations?","And what CosmosDB will do is it'll guarantee","that beyond this staleness window,","you'll have predictable consistency","outside of the staleness window.","And if the replicas","ever start to start lagging","behind beyond the maximum lag,","either in terms of operations or time,","what it'll do is that it'll start","applying back pressure on","the right path to force these replicas to catch up.","For session consistency, the session is actually","maintained in the form of a session token and by default,","the session tokens are cached by","the client SDK so you don't really have to","think about it when you're performing","a sequence of operations from the client SDK.","However, if you want to preserve","the session across a number of clients,","so let's say you scaled out a set of application servers,","and each time a user of","the application performs a request and might","actually be talking to a different application instance,","what you can do is you can extract the session in which","each time you perform any kind","of request and the response,","what you'll see is a session","token coming back from the response.","You can actually pass that back to","the downstream user client,","let's say the browser,","and persist that session token in the form of a cookie.","In that way, when they perform","a follow-up request and they have","a different application instance,","if you want to maintain that session consistency,","what you can do is you can override the session token on","their request option for the follow-up","read requests and make sure that that way,","they're always able to read their own writes","and guarantee the session consistency,","basically maintain their session across a set of clients.","And of course, consistency can always","be relaxed on a per-request basis.","So, let's say I have configured an account that uses","bounded staleness in which, for bounded staleness,","we're actually going to be performing quorum","reads to maintain the consistency guarantees.","However, let's say I have a specific request in","which I do not have as","strong of a consistency requirement.","And instead, for this particular request,","I just want the lowest latency","possible and the highest throughput possible.","What I can do is in the requests option is I can also set","the consistency level to a lower consistency level.","In that way, I","can make sure that that read is as fast as possible.","That concludes our video","on consistency. Thank you for watching."]}